<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DigiBot - Chat</title>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
    }

    body {
        height: 100vh;
        display: flex;
        background: #0E1217;
        color: white;
    }

    /* LEFT SIDEBAR */
    .sidebar {
        width: 260px;
        background: #1A1F25;
        border-right: 1px solid #2C323A;
        display: flex;
        flex-direction: column;
        padding: 20px;
    }

    .sidebar h2 {
        font-size: 20px;
        margin-bottom: 20px;
        text-align: center;
        color: #38ef7d;
    }

    .history-list {
        flex: 1;
        overflow-y: auto;
    }

    .history-item {
        background: #272D33;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .history-item:hover {
        background: #323A42;
    }

    .delete-btn {
        color: #ff4d4d;
        cursor: pointer;
        font-size: 18px;
        margin-left: 10px;
    }

    /* MAIN CHAT AREA */
    .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .chat-area {
        padding: 20px;
        overflow-y: auto;
        height: calc(100vh - 80px);
    }

    .message {
        margin-bottom: 20px;
        padding: 12px;
        border-radius: 8px;
        max-width: 70%;
    }

    .user-msg {
        background: #38ef7d;
        color: black;
        align-self: flex-end;
    }

    .bot-msg {
        background: #272D33;
        border: 1px solid #333;
        align-self: flex-start;
    }

    /* INPUT BAR */
    .input-area {
        height: 80px;
        border-top: 1px solid #2C323A;
        padding: 15px;
        display: flex;
        gap: 10px;
        background: #1A1F25;
    }

    .input-area input {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 6px;
        outline: none;
        background: #272D33;
        color: white;
        font-size: 16px;
    }

    .input-area button {
        background: #38ef7d;
        border: none;
        padding: 0 25px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
    }
</style>
</head>

<body>

<!-- LEFT SIDEBAR -->
<div class="sidebar">
    <h2>DigiBot</h2>
    <div class="history-list" id="historyList"></div>
</div>

<!-- RIGHT CHAT AREA -->
<div class="main">

    <div class="chat-area" id="chatArea"></div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Ask DigiBot something..." onkeydown="handleKey(event)">
        <button onclick="sendMessage()">Send</button>
    </div>

</div>

<script>

    let chatHistory = JSON.parse(localStorage.getItem("history")) || [];

    const chatArea = document.getElementById("chatArea");
    const historyList = document.getElementById("historyList");

    function handleKey(event) {
    if (event.key === "Enter") {
        event.preventDefault(); 
        sendMessage();
    }
}


    // Load chat history into sidebar
    function loadHistory() {
        historyList.innerHTML = "";

        chatHistory.forEach((item, index) => {
            const div = document.createElement("div");
            div.classList.add("history-item");

            div.innerHTML = `
                <span>${item.title}</span>
                <span class="delete-btn" onclick="deleteChat(event, ${index})">üóëÔ∏è</span>
            `;

            // Load chat when clicking title
            div.onclick = (e) => {
                if (e.target.classList.contains("delete-btn")) return;
                loadChat(index);
            };

            historyList.appendChild(div);
        });
    }

    loadHistory();

    // Delete chat
    function deleteChat(event, index) {
        event.stopPropagation();  
        chatHistory.splice(index, 1);
        localStorage.setItem("history", JSON.stringify(chatHistory));
        loadHistory();
        chatArea.innerHTML = "";
    }

    // Load selected chat
    function loadChat(index) {
        chatArea.innerHTML = "";
        chatHistory[index].messages.forEach(msg => {
            addMessage(msg.text, msg.sender);
        });
    }

    // Add messages to UI
    function addMessage(text, sender) {
        const div = document.createElement("div");
        div.classList.add("message", sender === "user" ? "user-msg" : "bot-msg");
        div.innerText = text;
        chatArea.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    // Send user message
    async function sendMessage() {
        const input = document.getElementById("userInput");
        const text = input.value.trim();
        if (!text) return;

        addMessage(text, "user");
        input.value = "";

        // If new conversation
        if (chatHistory.length === 0 || chatHistory[chatHistory.length - 1].messages.length === 0) {
            chatHistory.push({ title: text.slice(0, 20), messages: [] });
        }

        const currentChat = chatHistory[chatHistory.length - 1];
        currentChat.messages.push({ text, sender: "user" });
        localStorage.setItem("history", JSON.stringify(chatHistory));

        const botReply = await getBotReply(text);

        addMessage(botReply, "bot");
        currentChat.messages.push({ text: botReply, sender: "bot" });
        localStorage.setItem("history", JSON.stringify(chatHistory));

        loadHistory();
    }

    async function getBotReply(userMessage) {
        try {
            const res = await fetch("http://127.0.0.1:8000/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: userMessage })
            });

            const data = await res.json();
            return data.reply;

        } catch (error) {
            return "Error: Cannot reach server.";
        }
    }

</script>

</body>
</html>
